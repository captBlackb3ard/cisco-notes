# Network Switching - VLAN Hopping Attack Prevention

+ **Cisco Discovery Protocol (CDP)**: 
	+ A proprietary, link-layer protocol (layer 2) used by Cisco devices to share information about themselves and their directly connected neighbors, such as device types, interface names, IP addresses, and device capabilities.
	+ Cisco devices configured with CDP periodically send out multicase frames that advertised the device's identity, protocol addresses, platform, capabilities and a hold time (how long to keep the neighbour's info).
	+ Receiving devices cache the received info in a table allowing them to learn about the neighbours without needing Layer 3 connectivity.
	+ Network admins can view the cached info and discover what devices are directly connected: `sh cdp neighbours`


+ **VLAN Hopping**: 
	+ A technique used to gain unauthorised access to other VLANs in a network.
	+ Attacker sends crafted packets to a switch port intending to break out of their assigned VLAN and reach devices on a different VLAN.
	+ There are two primary techniques:
		+ _Double Tagging_: 
			- Attacker crafts ethernet frames with 2 VLAN tags; First tag matches the native VLAN of the trunk port & Second tag targets the victim VLAN. 
			- Switches do not inspect the second tag on ingress, the attacker bypasses normal VLAN restrictions.
			- Attack is possible when (1) Native VLAN on the trunk link is set to VLAN 1 or matches the attacker's VLAN, and (2) Attacker is connected to an access port in the Native VLAN.
		+ _Switch Spoofing_:
			- Attacker emulates a Cisco switch by sending Dynamic Trunking Protocol (DTP) packets to trick the switch into forming a trunk with the attacker's PC.
			- This grants access to multiple VLANs.
			- Only works if switchports are left in dynamic desirable or dynamic auto modes (default of Cisco switches).
	+ VLAN Hopping Mitigation can be implemented by configuring switches:
		+ Prevent Double Tagging - 
			- DO NOT USE VLAN 1 as the default VLAN for hosts; Change the native VLAN on all trunk ports to an unused VLAN, e.g., VLAN 55.
			- Explicitly tag Native VLAN traffic ensuring switched process all traffic with proper tagging.
			- Trunk, Native VLAN swap and Non-negotiate Commands:
				- `SW1(config)# int range fa0/1-2`
				- `SW1(config-if)# switchport mode trunk`
				- `SW1(config-if)# switchport trunk native vlan 33`
				- `SW1(config-if)# switchport nonegotiate`
			- Access ports and non-negotiate commands:
				- `SW1(config)# int range fa0/1-2`
				- `SW1(config-if)# switchport mdoe access`
				- `SW1(config-if)# switchport access vlan 10`
				- `SW1(config-if)# switchport nonegotiate`
		+ Prevent Switch Spoofing -
			- Manually configure all trunk ports using `switchport mode trunk`
			- Disable DTP with `switchport nonnegotiate`
			- Disable CDP globally with `no cdp run` to hide device info.

+ [Cisco Press: Troubleshooting VLANs](https://www.ciscopress.com/articles/article.asp?p=3089357&seqNum=7)

### Tasks
1. Create VLAN topology in Packet Tracer
2. Create VLANs & name (one for hosts and one as native)
3. ID access ports, assign them VLAN IDs, and one as Native
4. ID & config trunk ports, assign them native VLAN, and issue nonegotiate commands.
5. Disable CDP on switches.




#### Step 2 - Basic Switch Config & VLAN definition

**Switch 0**
! Basic Config
conf t
hostname SW0
ban motd ^Unauthorised Access is Prohibited. All Activity is Logged.^
enable password cisco123
service password-encryption
no ip domain-lookup
ip domain-name domain.com
vlan 10
name HR
exit
vlan 55
name NATIVE
exit

do wr

**Switch 1**
! Basic Config
conf t
hostname SW1
ban motd ^Unauthorised Access is Prohibited. All Activity is Logged.^
enable password cisco123
service password-encryption
no ip domain-lookup
ip domain-name domain.com
vlan 20
name PR
exit
vlan 55
name NATIVE
exit

do wr

**Switch 2**
! Basic Config
conf t
hostname SW2
ban motd ^Unauthorised Access is Prohibited. All Activity is Logged.^
enable password cisco123
service password-encryption
no ip domain-lookup
ip domain-name domain.com
vlan 30
name FIN
exit
vlan 55
name NATIVE
exit

do wr


### Step 3 - Assign VLAN IDs to Access Ports
**Switch 0**
int range f0/1-20, g0/1-2
switchport mode access
switchport access vlan 10
switchport nonegotiate
exit

do wr

**Switch 1**
int range f0/1-20, g0/1-2
switchport mode access
switchport access vlan 20
switchport nonegotiate
exit

do wr

**Switch 2**
int range f0/1-20, g0/1-2
switchport mode access
switchport access vlan 30
switchport nonegotiate
exit

do wr

### Step 4 - Config Trunks assign Native VLAN and nonegotiate
**Switch 0**
! Config Trunks
int range f0/21-24
switchport mode trunk
! Define Native VLAN 55
switchport trunk native vlan 55
switchport nonegotiate
exit

do sh int trunk

**Switch 1**
! Config Trunks
int range f0/21-24
switchport mode trunk
! Define Native VLAN 55
switchport trunk native vlan 55
switchport nonegotiate
exit

do sh int trunk

**Switch 2**
! Config Trunks
int range f0/21-24
switchport mode trunk
! Define Native VLAN 55
switchport trunk native vlan 55
exit

do sh int trunk


### Step 5 - Disable CDP on Switches (Prevent SwitchSpoofing)
! Global Config Mode
no cdp run

do wr

! View CDP config
do sh cdp