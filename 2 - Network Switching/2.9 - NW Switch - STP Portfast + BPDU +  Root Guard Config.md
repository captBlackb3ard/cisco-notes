# Network Switching - STP Portfast, BPDU Guard, & Root Guard Configs

+ **Spanning Tree Protocol (STP)**:
	+ A network protocol that prevents infinite loops by creating a logical loop-free topology in a swtiched network that has redundant paths.
	+ Achieves this by blocking redundant links, thus ensuring only one active path exists between any two points on the network.
	+ This prevents broadcast storms and ensures stable network operation, while also providing redundant paths that can be activated if the primary path fails.
	+ Operation:
		+ Switches exchange BDPUs to elect one switch as the _Root bridge_ (logical center of the network controlling which ports forward or block traffic to prevent the loops).
		+ Root Bridge is identified by its Bridge ID (BID): a combo of its Bridge Priority (32768 is the default value & also the highest value - the lower the better) and MAC address.
		+ The switch with the _lowest BID_ is elected as the Root Bridge; if the Bridge Priorities are equal, then the switch with the _lowest MAC Address_ is elected as the Root Bridge.
		+ All switches calculate the path cost (the shortest path) to the root brigde; the port on each non-root switch that offers the lowest cost path to the root bridge becomes the _Root Port_.
		+ For each network segment, one switch's port is selected as the _Designated Port_, providing the lowest cost path to the root bridge for that segment. 
		+ Any port not serving as a root port or designated port is placed in a blocking state to prevent it from forwarding traffic and creating a loop.
+ **STP PortFast**:
	+ Is an STP feature that allows an access port to immediately enter the forwarding state (from the blocking state), bypassing the normal STP listening and learning state for end-user devices.
	+ It reduces the time taken for a port to become active, enabling the devices to connect to the network faster without waiting for STP convergence.
	+ It should only be used on ports connected to a single edge host (non-trunking access ports) to prevent temporary bridging loops, because they typically do not send BPDUs.
+ **Bridge Protocol Data Unit (BPDU) Guard**:
	+ Because PortFast can be enabled on non-trunking ports connecting two switches, spanning-tree loops can occur because BPDUs are still being transmitted and received on those ports.
	+ _NOTE_: Every STP PortFast configured port should also be configured with with BPDU Guard; essentially preventing any switches being connected to these ports.
	+ PortFast BPDU Guard is a an STP feature that prevents the loop from happening by moving non-trunking switch ports into an _'err-disabled'_ state if it receives a BPDU.
	+ It is enabled on access ports using the PortFast feature and protects the network from unauthorized switches or devices being connected to the network, which could otherwise disrupt the STP topology
	+ To recover the port, the underlying issue must be resolved, and the port must be manually re-enabled
+ **Root Guard**:
	+ It is an STP feature that is enabled on a port-by-port basis; preventing a configured port from becoming a _Root Port_.
	+ Root Guard prevents a downstream switch (misconfigured or rogue) from becoming a root brigde in a network topology.
	+ Root Guard works by placing a port in an _'err-disabled'_ state if a superior BPDU (indicating a switch is attempting to become the new root bridge) is received on a configured port, effectively blocking traffic and protecting the intended STP topology.
	+ It prevents the configured _Designated Port_ with Root Guard from becoming a _Root Port_. 

### STP Attack Prevention
+ BPDU Guard and Root Guard prevent STP attacks:
	+ BPDU Guard disables ports that receive BPDUs which would otherwise disrupt the STP topology.
	+ Root Guard prevents a port from becoming the new root bridge by blocking superior BPDUs.
	+ Both are crucial for securing access layer ports and network core links against rogue/misconfigured switches attempting to usurp the root bridge role or cause DoS attacks through STP speculations.
+ Commands:
	+ View Switch Bridge Priority: `SW1> sh span`
	+ Change Bridge Priority: `SW1(config)# spanning-tree vlan 1-1005 priority 16384`
	+ Config Switch as Root: `SW1(config)# spanning-tree vlan 1-1005 root primary`
	+ Config Switch as Root (Redundancy): `SW1(config)# spanning-tree vlan 1-1005 root secondary`
+ Configration commands:
	+ PortFast Configuration for a user endpoint port/interface
	+ `SW1(config)# int f0/1` ! Port/Interface for user endpoint
		+ `SW1(config-if)# spanning-tree portfast`
		+ `SW1(config)# spanning-tree portfast default`
	+ PortFast & BPDU Guard Configuration
		+ `SW1(config)# in f0/1`
		+ `SW1(config-if)# spanning-tree portfast`
		+ `SW1(config-if)# spanning-tree bpduguard enable`
		+ `SW1(config-if)# spanning-tree portfast bpduguard default`
	+ Root Guard Configuration
		+ `SW1(config)# int f0/1`
		+ `SW1(config-if)# spanning-tree guard root`

### Tasks
1. Create VLAN topology in Packet Tracer
2. ID Trunk & Config (ID ROOT BRIDGE FIRST)
3. ID non-trunk ports + access ports (on SW0 + SW1) and config portfast and bpdu guard
4. Config root guard between SW3 + SW2 to prevent SW3 from becoming the Root Bridge
5. Display spanning-tree portfast info on SW0 + SW1

#### Step 2 - Config Switches and Trunk Ports
**Switch 0**
! Basic Config
conf t
hostname SW0
ban motd ^Unauthorised Access is Prohibited. All Activity is Logged.^
enable password cisco123
service password-encryption
no ip domain-lookup
ip domain-name domain.com
! Config Trunks
int range f0/1-2
switchport mode trunk
exit
do sh trunk

do wr

**Switch 1 (Root Bridge)**
! Basic Config
conf t
hostname SW1
ban motd ^Unauthorised Access is Prohibited. All Activity is Logged.^
enable password cisco123
service password-encryption
no ip domain-lookup
ip domain-name domain.com
! Make Switch Root Bridge
spanning-tree vlan 1-1005 root primary
! Config Trunks
int range f0/1-2
switchport mode trunk
exit
do sh int trunk

do wr

**Switch 2**
! Basic Config
conf t
hostname SW2
ban motd ^Unauthorised Access is Prohibited. All Activity is Logged.^
enable password cisco123
service password-encryption
no ip domain-lookup
ip domain-name domain.com
! Config Trunks
int range f0/1-2
switchport mode trunk
exit
do sh int trunk

do wr



**Switch 3**
! Basic Config
conf t
hostname SW3
ban motd ^Unauthorised Access is Prohibited. All Activity is Logged.^
enable password cisco123
service password-encryption
no ip domain-lookup
ip domain-name domain.com

do wr

#### Step 3 - ID Non-Trunk + Access Ports to Config PortFast and BPDU Guard

**Switch 0**
int range f0/3-24, g0/1-2
switchport mode access
spanning-tree portfast
spanning-tree bpduguard enable
exit
! Return to Global Config Mode
spanning-tree portfast default
spanning-tree portfast bpduguard default

do wr

**Switch 1 (Root Bridge)**
int range f0/3-24, g0/1-2
switchport mode access
spanning-tree portfast
spanning-tree bpduguard enable
exit
! Return to Global Config Mode
spanning-tree portfast default
spanning-tree portfast bpduguard default

do wr


**Switch 2**
! Port f0/3 Used for Trunk
int range f0/4-24, g0/1-2
switchport mode access
spanning-tree portfast
spanning-tree bpduguard enable
exit
! Return to Global Config Mode
spanning-tree portfast default
spanning-tree portfast bpduguard default

do wr

#### Step 4 - Config Root Guard Between SW2 + SW3

**Switch 2**
! Config Trunk
int range f0/3
switchport mode trunk
!Config Root Guard
spanning-tree guard root
exit

do wr

**Switch 3**
! Config Trunk
int range f0/1
switchport mode trunk
exit


#### Step 5 - View Spanning Tree Details Summary
sh spanning-tree summary